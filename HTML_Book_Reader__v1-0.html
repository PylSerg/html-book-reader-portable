<!DOCTYPE html>
<html lang="">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML Book Reader</title>

    <style>
        :root {
            --interface-background-color: #fff;
            --interface-font-size: 18px;
            --book-font-size: 20px;
        }

        body {
            display: flex;
            margin-left: 0px;
            margin-right: 0px;
            margin-top: 20px;
            margin-bottom: 0px;
            background-color: var(--interface-background-color);
            color: #000;
            font-size: 20px;
            font-family: Arial, Helvetica, sans-serif;
        }

        .dialog_window {
            position: fixed;
            top: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            display: none;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.75);
            z-index: 1000;
        }

        .dialog_window__container {
            max-width: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 10px;
            background-color: var(--interface-background-color);
            border: 3px solid #000;
            border-radius: 10px;
            overflow: hidden;
        }

        .dialog_window__text {
            padding: 20px;
            cursor: default;
        }

        .dialog_window__buttons {
            display: flex;
            flex-direction: row;
            justify-content: center;
            width: 100%;
            margin-top: 20px;
            border-top: 1px solid #000;
        }

        .dialog_window__button {
            width: 50%;
            padding: 10px;
            font-size: var(--interface-font-size);
            background: var(--interface-background-color);
            border: none;
            cursor: pointer;

            &:not(:last-child) {
                border-right: 1px solid #000;
            }

            &:hover {
                background-color: #000;
                color: #fff;
            }
        }

        .close_zone {
            position: fixed;
            top: 0;
            left: 0;
            display: none;
            width: 100vw;
            height: 100vh;
            background-color: transparent;
            z-index: 997
        }

        .toolbar__container {
            position: fixed;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: row;
            align-items: center;
            width: 100%;
            height: 20px;
            border-bottom: 1px solid #000;
            background-color: var(--interface-background-color);
            z-index: 999;
        }

        .toolbar__title {
            margin-left: 10px;
            font-size: 14px;
            font-weight: 700;
            cursor: default;
        }

        .toolbar__button {
            height: 100%;
            padding: 0 10px;
            background-color: transparent;
            border: 2px solid transparent;
            border: none;
            color: #000;
            font-size: 18px;
            font-weight: 700;
            text-align: center;
            cursor: pointer;
        }

        .toolbox__container {
            position: fixed;
            left: 10px;
            top: 30px;
            display: none;
            padding: 5px;
            background-color: var(--interface-background-color);
            border: 3px solid #000;
            border-radius: 10px;
            z-index: 998;

            & div {
                flex-direction: column;
                flex-wrap: nowrap;
                justify-content: start;
                align-items: start;
            }
        }

        .toolbox__button {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            width: 100%;
            padding: 20px;
            background-color: transparent;
            border: 2px solid transparent;
            border: none;
            color: #000;
            font-size: var(--interface-font-size);
            text-align: left;
            cursor: pointer;

            &:not(:last-child) {
                border-bottom: 2px solid #000;
            }
        }

        .toolbox__button:hover {
            color: #fff;
            background-color: #000;

            &:first-child {
                border-radius: 5px 5px 0 0;
            }

            &:last-child {
                border-radius: 0 0 5px 5px;
            }
        }

        .toolbox__main_tools {
            display: flex;
        }

        .toolbox__language_list {
            display: none;
        }

        .search_field {
            display: none;
        }

        .library__book_list__empty {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 50px;
            margin-top: 50px;
            width: 100%;
            height: 100%;
            color: #888;
            font-style: italic;
        }

        .library__book_list {}

        .author_section {
            margin-bottom: 30px;
        }

        .author_title {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 5px;
            font-weight: bold;
            border-bottom: 3px solid #000;
            cursor: default;
        }

        .author_counter {
            margin-left: 10px;
            color: #555;
            cursor: default;
        }

        .book_row {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            margin-left: 30px;
            padding: 10px;
            border-bottom: 1px solid #333;
            cursor: pointer;

            &:hover {
                background-color: #000;
                color: #fff;
            }
        }

        .book_progress {
            margin-left: 50px;
            color: #888;
            font-style: italic;
        }
    </style>
</head>

<body>
    <div class="close_zone" data-close-zone></div>
    <input type="file" accept=".html" multiple style="display: none;" data-add-file-input>
    <input class="search_field" type="text" name="search" placeholder="" data-search-field>

    <div class="toolbar__container">
        <button class="toolbar__button" type="button" data-toolbox-toggle-button>‚â°</button>
        <span class="toolbar__title" data-toolbar-title></span>
    </div>

    <div class="toolbox__container" data-toolbox-container>
        <div class="toolbox__main_tools" data-toolbox-main-tools>
            <button class="toolbox__button" type="button" data-full-screen-button></button>
            <button class="toolbox__button" type="button" data-find-book-button></button>
            <button class="toolbox__button" type="button" data-add-book-button></button>
            <button class="toolbox__button" type="button" data-clear-library-button></button>
            <button class="toolbox__button" type="button" data-language-button></button>
        </div>

        <div class="toolbox__language_list" data-language-list>
            <button class="toolbox__button" type="button" value="back" data-back-button></button>
        </div>
    </div>

    <div class="library__books_list" data-books-list></div>

    <div class="dialog_window" data-dialog-window>
        <div class="dialog_window__container">
            <div class="dialog_window__text" data-dialog-window-text></div>

            <div class="dialog_window__buttons">
                <button class="dialog_window__button" type="button" data-cancel-button></button>
                <button class="dialog_window__button" type="button" data-confirm-button></button>
            </div>
        </div>
    </div>

    <script>

        // TRANSLATION
        const translation = {
            language: {
                en: "English",
                uk: "–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞",
            },

            confirm: {
                en: "Yes",
                uk: "–¢–∞–∫",
            },

            cancel: {
                en: "Cancel",
                uk: "–°–∫–∞—Å—É–≤–∞—Ç–∏",
            },

            back: {
                en: "Back",
                uk: "–ù–∞–∑–∞–¥",
            },

            library: {
                en: "Library",
                uk: "–ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞",
            },

            menu: {
                en: "Menu",
                uk: "–ú–µ–Ω—é",
            },

            full_screen: {
                en: "Full screen",
                uk: "–ù–∞ –≤–µ—Å—å –µ–∫—Ä–∞–Ω",
            },

            find_book: {
                en: "Find book",
                uk: "–ó–Ω–∞–π—Ç–∏ –∫–Ω–∏–≥—É",
            },

            add_book: {
                en: "Add book",
                uk: "–î–æ–¥–∞—Ç–∏ –∫–Ω–∏–≥—É",
            },

            clear_library: {
                en: "Clear library",
                uk: "–û—á–∏—Å—Ç–∏—Ç–∏ –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É",
            },

            unknown_author: {
                en: "Unknown author",
                uk: "–ù–µ–≤—ñ–¥–æ–º–∏–π –∞–≤—Ç–æ—Ä",
            },

            library_empty: {
                en: "There are no books in your library",
                uk: "–£ –≤–∞—à—ñ–π –±—ñ–±–ª—ñ–æ—Ç–µ—Ü—ñ –∫–Ω–∏–≥ –Ω–µ–º–∞—î",
            },

            author_books_counter: {
                en: "Number of books by the author",
                uk: "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∫–Ω–∏–≥ –∞–≤—Ç–æ—Ä–∞",
            },

            no_IndexedDB_message: {
                en: "Your browser doesn't support the stable version of IndexedDB. Some features will be unavailable.",
                uk: "–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î —Å—Ç–∞–±—ñ–ª—å–Ω—É –≤–µ—Ä—Å—ñ—é IndexedDB. –î–µ—è–∫—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –±—É–¥—É—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ.",
            },

            clear_library_question: {
                en: "Are you sure want to delete ALL books from the library?",
                uk: "–í–∏ –¥—ñ–π—Å–Ω–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –£–°–Ü –∫–Ω–∏–≥–∏ –∑ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏?",
            },
        };


        // Refs
        const toolbar_title = document.querySelector("[data-toolbar-title]");
        const toolbox_container = document.querySelector("[data-toolbox-container]");
        const toolbox_main_tools = document.querySelector("[data-toolbox-main-tools]");
        const language_list = document.querySelector("[data-language-list]");
        const close_zone = document.querySelector("[data-close-zone]");
        const add_file_input = document.querySelector("[data-add-file-input]");
        const search_field = document.querySelector("[data-search-field]");
        const dialog_window = document.querySelector("[data-dialog-window]");
        const dialog_window_text = document.querySelector("[data-dialog-window-text]");
        const books_list = document.querySelector("[data-books-list]");

        // Buttons
        const toolbox_toggle_button = document.querySelector("[data-toolbox-toggle-button]");
        const cancel_button = document.querySelector("[data-cancel-button]");
        const confirm_button = document.querySelector("[data-confirm-button]");
        const back_button = document.querySelector("[data-back-button]");
        const full_screen_button = document.querySelector("[data-full-screen-button]");
        const find_book_button = document.querySelector("[data-find-book-button]");
        const add_book_button = document.querySelector("[data-add-book-button]");
        const clear_library_button = document.querySelector("[data-clear-library-button]");
        const language_button = document.querySelector("[data-language-button]");


        // Switches
        let lang = localStorage.getItem("lang") || window.clientInformation.language;
        let is_lib_screen = true;
        let is_toolbox = false;


        // Automatic translation for the selected language
        function tr(label) { return translation[`${label}`][`${lang}`] || translation[`${label}`].en; };

        function translateLabels() {
            toolbar_title.innerHTML = is_lib_screen ? tr("library") : "–ö–Ω–∏–≥–∞";
            toolbox_toggle_button.title = tr("menu");
            confirm_button.innerHTML = tr("confirm");
            cancel_button.innerHTML = tr("cancel");
            back_button.innerHTML = `ü†î &nbsp; ${tr("back")}`;
            full_screen_button.innerHTML = tr("full_screen");
            find_book_button.innerHTML = tr("find_book");
            add_book_button.innerHTML = tr("add_book");
            clear_library_button.innerHTML = tr("clear_library");
            language_button.innerHTML = `<span>${tr("language")}</span> <span>></span>`;
        }

        document.documentElement.setAttribute("lang", lang);
        translateLabels();


        // Creates languages list
        for (l in translation.language) {
            const lang_button = document.createElement("button");

            lang_button.setAttribute("class", "toolbox__button");
            lang_button.setAttribute("value", l);
            lang_button.setAttribute("onclick", `change_language("${l}")`);

            if (l === lang) {
                lang_button.textContent = "‚úì " + translation.language[l];
                lang_button.setAttribute("style", "font-weight: bold");
            } else {
                lang_button.textContent = translation.language[l];
            };


            language_list.appendChild(lang_button);
        };


        // Create DB
        window.indexedDB =
            window.indexedDB ||
            window.mozIndexedDB ||
            window.webkitIndexedDB ||
            window.msIndexedDB;

        window.IDBTransaction =
            window.IDBTransaction ||
            window.webkitIDBTransaction ||
            window.msIDBTransaction;

        window.IDBKeyRange =
            window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;

        if (!window.indexedDB) window.alert(tr(no_IndexedDB_message));

        let db;
        const db_name = "HTML_BOOK_READER";
        const request = indexedDB.open(db_name, 1);


        request.onupgradeneeded = function (event) { event.target.result.createObjectStore("books", { keyPath: "id" }); };
        request.onerror = function (event) { window.alert(event.target.error) };
        request.onsuccess = function (event) {
            db = event.target.result;
            renderLibrary();
        };


        // Render books library
        function renderLibrary() {
            const tx = db.transaction("books", "readonly");
            const store = tx.objectStore("books");
            const requestAll = store.getAll();

            requestAll.onsuccess = () => {
                const books = requestAll.result;
                const search = search_field.value.toLowerCase();

                if (!books[0]) {
                    books_list.setAttribute("class", "library__book_list__empty");
                    books_list.innerHTML = tr("library_empty");

                    const abb = document.createElement("div");
                    abb.setAttribute("onclick", "add_file_input.click()");
                    abb.setAttribute("style", "font-weight:bold;font-style:normal;cursor:pointer;");
                    abb.textContent = "‚ûï " + tr("add_book");
                    books_list.appendChild(abb);
                    return;
                };

                books_list.setAttribute("class", "library__book_list");

                toolbar_title.innerHTML = `${toolbar_title.textContent} &nbsp;&nbsp; [ ${books.length} ]`;

                const groups = {};

                books.filter(b => b.title.toLowerCase().includes(search) || b.author.toLowerCase().includes(search))
                    .forEach(b => {
                        if (!groups[b.author]) groups[b.author] = [];
                        groups[b.author].push(b);
                    });

                Object.keys(groups).sort().forEach(author => {
                    const sec = document.createElement("div");

                    sec.className = "author_section";

                    sec.innerHTML = `
                            <div class="author_title">
                                <span>${author}</span>
                                <span class="author_counter" title="${tr('author_books_counter')}">[ ${groups[author].length} ]</span>
                            </div >
                        `;

                    groups[author].sort((a, b) => a.title.localeCompare(b.title)).forEach(book => {
                        const row = document.createElement("div");

                        row.className = "book_row";

                        row.innerHTML = `
                            <div class="book_link">${book.title}</div>
                            <div class="book_progress">${book.progress}%</div>
                        `;

                        row.querySelector(".book_link").onclick = () => openBook(book);
                        sec.appendChild(row);
                    });

                    books_list.appendChild(sec);
                });
            };
        };


        // Tracks buttons presses
        close_zone.addEventListener("click", () => {
            close_zone.style.display = "none";
            toolbox_container.style.display = "none";
            is_toolbox = false;
        });

        cancel_button.addEventListener("click", () => {
            reset_dialog_window();
        });

        toolbox_toggle_button.addEventListener("click", () => {
            toolbox_container.style.display = is_toolbox ? "none" : "flex";
            is_toolbox = !is_toolbox;
            language_list.style.display = "none";
            toolbox_main_tools.style.display = "flex";

            if (is_toolbox) {
                close_zone.style.display = "block";
            } else {
                close_zone.style.display = "none";
            };
        });

        add_book_button.addEventListener("click", () => {
            add_file_input.click()
        });

        add_file_input.addEventListener("change", async (event) => {
            const files = Array.from(event.target.files);

            for (const file of files) {
                const text = await file.text();
                const doc = new DOMParser().parseFromString(text, "text/html");
                const bookData = {
                    id: id_gen(4),
                    progress: 0,
                    author: doc.querySelector("h2")?.innerText.trim() || tr("unknown_author"),
                    title: doc.querySelector("h1")?.innerText.trim() || file.name.replace(".html", ""),
                    content: doc.body.innerHTML
                };

                const tx = db.transaction("books", "readwrite");
                tx.objectStore("books").put(bookData);
            }

            location.reload();

        });

        clear_library_button.addEventListener("click", () => {
            dialog_window_text.innerHTML = tr("clear_library_question");

            is_toolbox = false;
            toolbox_container.style.display = "none";
            close_zone.style.display = "none";
            dialog_window.style.display = "flex";

            confirm_button.setAttribute("onclick", "clear_library()");
        });

        language_button.addEventListener("click", () => {
            toolbox_main_tools.style.display = "none";
            language_list.style.display = "flex";
        });

        back_button.addEventListener("click", () => {
            language_list.style.display = "none";
            toolbox_main_tools.style.display = "flex";
        });



        // Reset dialog window
        function reset_dialog_window() {
            dialog_window.style.display = "none";
            dialog_window_text.innerHTML = "";
            confirm_button.removeAttribute("onclick");
        };

        // Delete all books in library
        function clear_library() {
            db.transaction("books", "readwrite").objectStore("books").clear();
            reset_dialog_window();
            location.reload();
        };

        // Changes the language of the program
        function change_language(lng) {
            document.documentElement.setAttribute("lang", lng);
            localStorage.setItem("lang", lng);
            location.reload();
        };

        // ID generator
        function id_gen(n = 1) {
            let id = "";
            for (let i = 1; i <= n; i++) { id = id + Math.random().toString(36).substring(2, 10); };
            return id;
        };
    </script>
</body>

</html>