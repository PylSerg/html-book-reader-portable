<!DOCTYPE html>
<html lang="">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML Book Reader</title>

    <style>
        :root {
            --interface-font-size: 18px;
            --book-font-size: 20px;
        }

        body {
            display: flex;
            margin-left: 0px;
            margin-right: 0px;
            margin-top: 20px;
            margin-bottom: 0px;
            background-color: #fff;
            color: #000;
            font-size: 20px;
            font-family: Arial, Helvetica, sans-serif;
        }

        .close_zone {
            position: fixed;
            top: 0;
            left: 0;
            display: none;
            width: 100vw;
            height: 100vh;
            background-color: transparent;
            z-index: 997
        }

        .toolbar__container {
            position: fixed;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: row;
            align-items: center;
            width: 100%;
            height: 20px;
            border-bottom: 1px solid #000;
            z-index: 999;
        }

        .toolbar__title {
            margin-left: 10px;
            font-size: 14px;
            font-weight: 700;
            cursor: default;
        }

        .toolbar__button {
            height: 100%;
            padding: 0 10px;
            background-color: transparent;
            border: 2px solid transparent;
            border: none;
            color: #000;
            font-size: 18px;
            font-weight: 700;
            text-align: center;
            cursor: pointer;
        }

        .toolbox__container {
            position: fixed;
            left: 10px;
            top: 30px;
            display: none;
            padding: 5px;
            border: 3px solid #000;
            border-radius: 10px;
            z-index: 998;

            & div {
                flex-direction: column;
                flex-wrap: nowrap;
                justify-content: start;
                align-items: start;
            }
        }

        .toolbox__button {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            width: 100%;
            padding: 20px;
            background-color: transparent;
            border: 2px solid transparent;
            border: none;
            color: #000;
            font-size: var(--interface-font-size);
            text-align: left;
            cursor: pointer;

            &:not(:last-child) {
                border-bottom: 2px solid #000;
            }
        }

        .toolbox__button:hover {
            color: #fff;
            background-color: #000;

            &:first-child {
                border-radius: 5px 5px 0 0;
            }

            &:last-child {
                border-radius: 0 0 5px 5px;
            }
        }

        .toolbox__main_tools {
            display: flex;
        }

        .toolbox__language_list {
            display: none;
        }
    </style>
</head>

<body>
    <div class="close_zone" data-close-zone></div>
    <input type="file" accept=".html" multiple style="display: none;" data-add-file-input>

    <div class="toolbar__container">
        <button class="toolbar__button" type="button" data-toolbox-toggle-button>‚â°</button>
        <span class="toolbar__title" data-toolbar-title></span>
    </div>

    <div class="toolbox__container" data-toolbox-container>
        <div class="toolbox__main_tools" data-toolbox-main-tools>
            <button class="toolbox__button" type="button" data-full-screen-button></button>
            <button class="toolbox__button" type="button" data-find-book-button></button>
            <button class="toolbox__button" type="button" data-add-book-button></button>
            <button class="toolbox__button" type="button" data-clear-library-button></button>
            <button class="toolbox__button" type="button" data-language-button></button>
        </div>

        <div class="toolbox__language_list" data-language-list>
            <button class="toolbox__button" type="button" value="back" data-back-button></button>
        </div>
    </div>

    <script>

        // TRANSLATION
        const translation = {
            language: {
                en: "English",
                uk: "–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞",
            },

            back: {
                en: "Back",
                uk: "–ù–∞–∑–∞–¥",
            },

            library: {
                en: "Library",
                uk: "–ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞",
            },

            menu: {
                en: "Menu",
                uk: "–ú–µ–Ω—é",
            },

            full_screen: {
                en: "Full screen",
                uk: "–ù–∞ –≤–µ—Å—å –µ–∫—Ä–∞–Ω",
            },

            find_book: {
                en: "Find book",
                uk: "–ó–Ω–∞–π—Ç–∏ –∫–Ω–∏–≥—É",
            },

            add_book: {
                en: "Add book",
                uk: "–î–æ–¥–∞—Ç–∏ –∫–Ω–∏–≥—É",
            },

            clear_library: {
                en: "Clear library",
                uk: "–û—á–∏—Å—Ç–∏—Ç–∏ –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É",
            },

            unknown_author: {
                en: "Unknown author",
                uk: "–ù–µ–≤—ñ–¥–æ–º–∏–π –∞–≤—Ç–æ—Ä",
            },

            no_IndexedDB_message: {
                en: "Your browser doesn't support the stable version of IndexedDB. Some features will be unavailable.",
                uk: "–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î —Å—Ç–∞–±—ñ–ª—å–Ω—É –≤–µ—Ä—Å—ñ—é IndexedDB. –î–µ—è–∫—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –±—É–¥—É—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ.",
            },
        };


        // Refs
        const toolbar_title = document.querySelector("[data-toolbar-title]");
        const toolbox_container = document.querySelector("[data-toolbox-container]");
        const toolbox_main_tools = document.querySelector("[data-toolbox-main-tools]");
        const language_list = document.querySelector("[data-language-list]");
        const close_zone = document.querySelector("[data-close-zone]");
        const add_file_input = document.querySelector("[data-add-file-input]");

        // Buttons
        const toolbox_toggle_button = document.querySelector("[data-toolbox-toggle-button]");
        const back_button = document.querySelector("[data-back-button]");
        const full_screen_button = document.querySelector("[data-full-screen-button]");
        const find_book_button = document.querySelector("[data-find-book-button]");
        const add_book_button = document.querySelector("[data-add-book-button]");
        const clear_book_button = document.querySelector("[data-clear-library-button]");
        const language_button = document.querySelector("[data-language-button]");


        // Switches
        let lang = window.clientInformation.language;
        let is_lib_screen = true;
        let is_toolbox = false;


        // Automatic translation for the selected language
        function tr(label) { return translation[`${label}`][`${lang}`] || translation[`${label}`].en; };

        function translateLabels() {
            toolbar_title.innerHTML = is_lib_screen ? tr("library") : "–ö–Ω–∏–≥–∞";
            toolbox_toggle_button.title = tr("menu");
            back_button.innerHTML = `ü†î &nbsp; ${tr("back")}`;
            full_screen_button.innerHTML = tr("full_screen");
            find_book_button.innerHTML = tr("find_book");
            add_book_button.innerHTML = tr("add_book");
            clear_book_button.innerHTML = tr("clear_library");
            language_button.innerHTML = `<span>${tr("language")}</span> <span>></span>`;
        }

        document.documentElement.setAttribute("lang", lang);
        translateLabels();


        // Creates languages list
        for (l in translation.language) {
            const lang_button = document.createElement("button");

            lang_button.setAttribute("class", "toolbox__button");
            lang_button.setAttribute("value", l);
            lang_button.setAttribute("onclick", `change_language("${l}")`);

            if (l === lang) {
                lang_button.textContent = "‚úì " + translation.language[l];
                lang_button.setAttribute("style", "font-weight: bold");
            } else {
                lang_button.textContent = translation.language[l];
            };


            language_list.appendChild(lang_button);
        };


        // Create DB
        window.indexedDB =
            window.indexedDB ||
            window.mozIndexedDB ||
            window.webkitIndexedDB ||
            window.msIndexedDB;

        window.IDBTransaction =
            window.IDBTransaction ||
            window.webkitIDBTransaction ||
            window.msIDBTransaction;

        window.IDBKeyRange =
            window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;

        if (!window.indexedDB) window.alert(tr(no_IndexedDB_message));

        let db = {};
        const db_name = "HTML_BOOK_READER";
        const request = indexedDB.open(db_name, 1);

        request.onupgradeneeded = function (event) {
            const db = event.target.result;
            const objectStore = db.createObjectStore("books", { keyPath: "id" });
        };

        request.onerror = function (event) { window.alert(event.target.error) };
        request.onsuccess = function (event) { db = event.target.result; };


        // Tracks buttons presses
        close_zone.addEventListener("click", () => {
            close_zone.style.display = "none";
            toolbox_container.style.display = "none";
            is_toolbox = false;
        });

        toolbox_toggle_button.addEventListener("click", () => {
            toolbox_container.style.display = is_toolbox ? "none" : "flex";
            is_toolbox = !is_toolbox;
            language_list.style.display = "none";
            toolbox_main_tools.style.display = "flex";

            if (is_toolbox) {
                close_zone.style.display = "block";
            } else {
                close_zone.style.display = "none";
            };
        });

        add_book_button.addEventListener("click", () => add_file_input.click());

        add_file_input.addEventListener("change", async (event) => {
            const files = Array.from(event.target.files);

            for (const file of files) {
                const text = await file.text();
                const doc = new DOMParser().parseFromString(text, "text/html");
                const bookData = {
                    id: id_gen(4),
                    progress: 0,
                    author: doc.querySelector("h2")?.innerText.trim() || tr("unknown_author"),
                    title: doc.querySelector("h1")?.innerText.trim() || file.name.replace(".html", ""),
                    content: doc.body.innerHTML
                };

                const tx = db.transaction("books", "readwrite");
                tx.objectStore("books").put(bookData);
            }
        });

        language_button.addEventListener("click", () => {
            toolbox_main_tools.style.display = "none";
            language_list.style.display = "flex";
        });

        back_button.addEventListener("click", () => {
            language_list.style.display = "none";
            toolbox_main_tools.style.display = "flex";
        });


        // Changes the language of the program
        function change_language(lng) {
            lang = lng;
            document.documentElement.setAttribute("lang", lng);
            translateLabels();

            const ln_l = language_list.querySelectorAll("button");

            ln_l.forEach(ln => {
                if (ln.value !== lang && ln.value !== "back") {
                    ln.textContent = translation.language[`${ln.value}`];
                    ln.setAttribute("style", "font-weight: normal");
                };

                if (ln.value === lang && ln.value !== "back") {
                    ln.textContent = "‚úì " + translation.language[`${ln.value}`];
                    ln.setAttribute("style", "font-weight: bold");
                };
            });
        };

        // ID generator
        function id_gen(n = 1) {
            let id = "";
            for (let i = 1; i <= n; i++) { id = id + Math.random().toString(36).substring(2, 10); };
            return id;
        };
    </script>
</body>

</html>