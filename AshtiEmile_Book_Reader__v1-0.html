<!DOCTYPE html>
<html lang="">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AshtiEmile Reader</title>

    <style>
        :root {
            --interface-background-color: #fff;
            --interface-font-size: 18px;
            --scrollbar-thumb-height: auto;
            --scrollbar-progress: 0%;

            --book-font-size: 20px;
            --book-line-height: 1.5em;
            --book-horizontal-paddings: 20%;
            --book-vertical-paddings: 2%;
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-left: 0px;
            margin-right: 0px;
            margin-top: 20px;
            margin-bottom: 0px;
            background-color: var(--interface-background-color);
            color: #000;
            font-size: 20px;
            font-family: Arial, Helvetica, sans-serif;
        }

        body::-webkit-scrollbar {
            width: 10px;
            color: #fff;
            background-color: #fff;
            outline: 1px solid #000;
        }

        body::-webkit-scrollbar-thumb {
            height: var(--scrollbar-thumb-height);
            background-color: #000;
            cursor: pointer;
        }

        body::-webkit-scrollbar-track {
            background: linear-gradient(to bottom,
                    #000 var(--scrollbar-progress),
                    #fff var(--scrollbar-progress));
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            text-align: center;
        }

        .dialog_window {
            position: fixed;
            top: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            display: none;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.75);
            pointer-events: all;
            z-index: 1001;
        }

        .dialog_window__container {
            max-width: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 10px;
            background-color: var(--interface-background-color);
            border: 3px solid #000;
            border-radius: 10px;
            overflow: hidden;
        }

        .dialog_window__text {
            padding: 20px;
            cursor: default;
        }

        .dialog_window__buttons {
            display: flex;
            flex-direction: row;
            justify-content: center;
            width: 100%;
            margin-top: 20px;
            border-top: 1px solid #000;
        }

        .dialog_window__button {
            width: 50%;
            padding: 10px;
            font-size: var(--interface-font-size);
            background: var(--interface-background-color);
            border: none;
            cursor: pointer;

            &:not(:last-child) {
                border-right: 1px solid #000;
            }

            &:hover {
                background-color: #000;
                color: #fff;
            }
        }

        .close_zone {
            position: fixed;
            top: 0;
            left: 0;
            display: none;
            width: 100vw;
            height: 100vh;
            background-color: transparent;
            pointer-events: all;
            z-index: 1000;
        }

        .toolbar__container {
            position: fixed;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            width: 100%;
            height: 20px;
            border-bottom: 1px solid #000;
            background-color: var(--interface-background-color);
            z-index: 999;
        }

        .toolbar__left_side,
        .toolbar__right_side {
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        .toolbar__button {
            height: 100%;
            padding: 0 10px;
            background-color: transparent;
            border: 2px solid transparent;
            border: none;
            color: #000;
            font-size: 18px;
            font-weight: 700;
            text-align: center;
            cursor: pointer;

            &:hover {
                background-color: #000;
                color: #fff;
            }
        }

        .toolbar__title {
            margin-left: 10px;
            font-size: 14px;
            font-weight: 700;
            cursor: default;
        }

        .toolbar__progress_indicator,
        .toolbar__battery_info,
        .reload_page_button {
            color: #555;
            font-size: 14px;
        }

        .toolbar__progress_indicator {
            display: none;
            padding-right: 10px;
            border-right: 1px solid #888;
            cursor: default;
        }

        .toolbar__battery_info {}

        .reload_page_button {
            height: 100%;
            font-weight: 700;
            background-color: var(--interface-background-color);
            border: none;
            margin: 0;
            padding: 0 10px;
            cursor: pointer;

            &:hover {
                background-color: #000;
                color: #fff;
            }
        }

        .toolbox__container {
            position: fixed;
            left: 10px;
            top: 30px;
            display: none;
            max-height: 70vh;
            padding: 5px;
            background-color: var(--interface-background-color);
            border: 3px solid #000;
            border-radius: 10px;
            box-shadow: 5px 5px 10px #555;
            overflow: auto;
            z-index: 1001;

            & div {
                flex-direction: column;
                flex-wrap: nowrap;
                justify-content: start;
                align-items: start;
            }
        }

        .toolbox__button {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            width: 100%;
            padding: 20px;
            background-color: transparent;
            border: 2px solid transparent;
            border: none;
            color: #000;
            font-size: var(--interface-font-size);
            text-align: left;
            cursor: pointer;

            &:not(:last-child) {
                border-bottom: 2px solid #000;
            }
        }

        .toolbox__button:hover {
            color: #fff;
            background-color: #000;

            &:first-child {
                border-radius: 5px 5px 0 0;
            }

            &:last-child {
                border-radius: 0 0 5px 5px;
            }
        }

        .toolbox__main_tools {
            display: flex;
        }

        .toolbox__language_list {
            display: none;
        }

        .toolbox__reader_tools {
            display: none;
        }

        .library__container {
            width: 100%;
            max-width: 800px;
        }

        .search__container {
            position: relative;
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
            width: 100%;
            margin-top: 10px;
            margin-bottom: 30px;
            border-bottom: 1px solid #aaa;
        }

        .search_field {
            width: 100%;
            margin: 0;
            padding: 6px;
            padding-right: calc(var(--interface-font-size)*2);
            border: none;
            font-size: var(--interface-font-size);
            font-style: italic;

            &::placeholder {
                color: #aaa;
                font-style: italic;
            }

            &:focus-visible {
                outline: none;

                &::placeholder {
                    color: transparent;
                }
            }
        }

        .search_clear_button {
            position: absolute;
            top: 0;
            right: 0;
            margin: 0;
            padding: 1px 10px;
            color: #aaa;
            font-size: var(--interface-font-size);
            font-weight: bold;
            background-color: var(--interface-background-color);
            border: none;
            cursor: pointer;

            &:hover {
                background-color: #000;
                color: #fff;
            }
        }

        .library__book_list__empty {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 50px;
            margin-top: 50px;
            width: 100%;
            height: 100%;
            color: #888;
            font-style: italic;
        }

        .library__book_list {
            padding: 0 10px;
            margin-bottom: 300px;
        }

        .author__section {
            margin-bottom: 30px;
            border: 3px solid #000;
            border-radius: 10px;
            box-shadow: 5px 5px 10px #ccc;
        }

        .author__title {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            margin-bottom: 0px;
            padding: 10px;
            background-color: #eee;
            font-weight: bold;
            border-bottom: 3px solid #000;
            border-radius: 10px 10px 0 0;
            cursor: default;
        }

        .author__counter {
            margin-left: 10px;
            color: #777;
            cursor: default;
        }

        .book__row {
            position: relative;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            padding: 10px;
            cursor: pointer;

            &:not(:last-child) {
                border-bottom: 1px solid #333;
            }

            &:hover {
                background-color: #000;
                color: #fff;
            }
        }

        .book__info {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .book__progress {
            margin-left: 50px;
            color: #888;
            font-style: italic;
        }

        .book__actions_button {
            padding: 0 10px;
            border-radius: 5px;

            &:hover {
                background-color: var(--interface-background-color);
                color: #000;
            }
        }

        .actions_tools__container {
            position: absolute;
            top: 40px;
            right: 0;
            display: flex;
            flex-direction: column;
            max-height: 70vh;
            padding: 5px;
            background-color: var(--interface-background-color);
            border: 3px solid #000;
            border-radius: 10px;
            box-shadow: -5px 5px 10px #555;
            overflow: auto;
            z-index: 1001;
        }

        .rename_book__form {
            display: flex;
            flex-direction: column;
        }

        .rename_book__input {
            margin-top: 10px;
            margin-bottom: 30px;
            font-size: var(--book-font-size);
            border: none;
            border-bottom: 2px solid #aaa;
            outline: none;
        }

        .rename_book__question {
            margin-top: 30px;
            text-align: center;
        }

        .reader__container {
            width: 100%;
        }

        .reader__book {
            display: flex;
            justify-content: center;
            line-height: var(--book-line-height);
            text-align: justify;
            padding: var(--book-vertical-paddings) var(--book-horizontal-paddings);
            padding-bottom: 90vh;
        }
    </style>
</head>

<body>
    <div class="close_zone" data-close-zone></div>
    <input type="file" accept=".html" multiple style="display: none;" data-add-file-input>

    <div class="toolbar__container">
        <div class="toolbar__left_side">
            <button class="toolbar__button" type="button" data-toolbox-toggle-button>â‰¡</button>
            <span class="toolbar__title" data-toolbar-title></span>
        </div>

        <div class="toolbar__right_side">
            <span class="toolbar__progress_indicator" data-toolbar-progress-indicator></span>
            <span class="toolbar__battery_info" data-toolbar-battery-info></span>
            <button class="reload_page_button" type="button" data-reload-page>â†»</button>
        </div>
    </div>

    <div class="toolbox__container" data-toolbox-container>
        <div class="toolbox__libraty_tools" data-library-tools>
            <div class="toolbox__main_tools" data-toolbox-main-tools>
                <button class="toolbox__button" type="button" data-full-screen-button></button>
                <button class="toolbox__button" type="button" data-add-book-button></button>
                <button class="toolbox__button" type="button" data-clear-library-button></button>
                <button class="toolbox__button" type="button" data-language-button></button>
            </div>

            <div class="toolbox__language_list" data-language-list>
                <button class="toolbox__button" type="button" value="back" data-back-button></button>
            </div>
        </div>

        <div class="toolbox__reader_tools" data-reader-tools>
            <button class="toolbox__button" type="button" data-back-to-library-button></button>
            <button class="toolbox__button" type="button" data-full-screen-button2></button>
        </div>
    </div>

    <div class="library__container" data-library-container>
        <div class="search__container">
            <input class="search_field" type="text" name="search" data-search-field>
            <button class="search_clear_button" type="button" data-search-clear-button>â›Œ</button>
        </div>

        <div class="library__books_list" data-books-list></div>
    </div>

    <div class="reader__container" data-reader-container>
        <div class="reader__book" data-reader-book></div>
    </div>

    <div class="dialog_window" data-dialog-window>
        <div class="dialog_window__container">
            <div class="dialog_window__text" data-dialog-window-text></div>

            <div class="dialog_window__buttons">
                <button class="dialog_window__button" type="button" data-cancel-button></button>
                <button class="dialog_window__button" type="button" data-confirm-button></button>
            </div>
        </div>
    </div>

    <script>

        // TRANSLATION
        const translation = {
            language: {
                en: "English",
                uk: "Ð£ÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ°",
            },

            confirm: {
                en: "Yes",
                uk: "Ð¢Ð°Ðº",
            },

            cancel: {
                en: "Cancel",
                uk: "Ð¡ÐºÐ°ÑÑƒÐ²Ð°Ñ‚Ð¸",
            },

            back: {
                en: "Back",
                uk: "ÐÐ°Ð·Ð°Ð´",
            },

            library: {
                en: "Library",
                uk: "Ð‘Ñ–Ð±Ð»Ñ–Ð¾Ñ‚ÐµÐºÐ°",
            },

            menu: {
                en: "Menu",
                uk: "ÐœÐµÐ½ÑŽ",
            },

            reload_page: {
                en: "Reload page",
                uk: "ÐŸÐµÑ€ÐµÐ·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶Ð¸Ñ‚Ð¸ ÑÑ‚Ð¾Ñ€Ñ–Ð½ÐºÑƒ",
            },

            full_screen: {
                en: "Full screen",
                uk: "ÐÐ° Ð²ÐµÑÑŒ ÐµÐºÑ€Ð°Ð½",
            },

            add_book: {
                en: "Add book",
                uk: "Ð”Ð¾Ð´Ð°Ñ‚Ð¸ ÐºÐ½Ð¸Ð³Ñƒ",
            },

            clear_library: {
                en: "Clear library",
                uk: "ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚Ð¸ Ð±Ñ–Ð±Ð»Ñ–Ð¾Ñ‚ÐµÐºÑƒ",
            },

            unknown_author: {
                en: "Unknown author",
                uk: "ÐÐµÐ²Ñ–Ð´Ð¾Ð¼Ð¸Ð¹ Ð°Ð²Ñ‚Ð¾Ñ€",
            },

            library_empty: {
                en: "There are no books in your library",
                uk: "Ð£ Ð²Ð°ÑˆÑ–Ð¹ Ð±Ñ–Ð±Ð»Ñ–Ð¾Ñ‚ÐµÑ†Ñ– ÐºÐ½Ð¸Ð³ Ð½ÐµÐ¼Ð°Ñ”",
            },

            search_placeholder: {
                en: "Search book...",
                uk: "Ð¨ÑƒÐºÐ°Ñ‚Ð¸ ÐºÐ½Ð¸Ð³Ñƒ...",
            },

            recent: {
                en: "Reading now",
                uk: "Ð—Ð°Ñ€Ð°Ð· Ñ‡Ð¸Ñ‚Ð°ÑŽ",
            },

            favorite: {
                en: "Favorites books",
                uk: "Ð£Ð»ÑŽÐ±Ð»ÐµÐ½Ñ– ÐºÐ½Ð¸Ð³Ð¸",
            },

            author_books_counter: {
                en: "Number of books by the author",
                uk: "ÐšÑ–Ð»ÑŒÐºÑ–ÑÑ‚ÑŒ ÐºÐ½Ð¸Ð³ Ð°Ð²Ñ‚Ð¾Ñ€Ð°",
            },

            book_author: {
                en: "Author",
                uk: "ÐÐ²Ñ‚Ð¾Ñ€",
            },

            book_title: {
                en: "Title",
                uk: "ÐÐ°Ð·Ð²Ð°",
            },

            read_title: {
                en: "Read",
                uk: "ÐŸÑ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð¾",
            },

            favorite_title: {
                en: "Added to favorites",
                uk: "Ð”Ð¾Ð´Ð°Ð½Ð¾ Ð´Ð¾ ÑƒÐ»ÑŽÐ±Ð»ÐµÐ½Ð¸Ñ…",
            },

            book_actions_title: {
                en: "Actions",
                uk: "Ð”Ñ–Ñ—",
            },

            add_to_favorites: {
                en: "Add to favorites",
                uk: "Ð”Ð¾Ð´Ð°Ñ‚Ð¸ Ð´Ð¾ ÑƒÐ»ÑŽÐ±Ð»ÐµÐ½Ð¾Ð³Ð¾",
            },

            remove_from_favorites: {
                en: "Remove from favorites",
                uk: "Ð’Ð¸Ð»ÑƒÑ‡Ð¸Ñ‚Ð¸ Ð· ÑƒÐ»ÑŽÐ±Ð»ÐµÐ½Ð¾Ð³Ð¾",
            },

            mark_as_read: {
                en: "Mars as read",
                uk: "ÐŸÐ¾Ð·Ð½Ð°Ñ‡Ð¸Ñ‚Ð¸ Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð¾ÑŽ",
            },

            mark_as_unread: {
                en: "Mars as unread",
                uk: "ÐŸÐ¾Ð·Ð½Ð°Ñ‡Ð¸Ñ‚Ð¸ Ð½ÐµÐ¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð¾ÑŽ",
            },

            rename_book: {
                en: "Rename book",
                uk: "ÐŸÐµÑ€ÐµÐ¹Ð¼ÐµÐ½ÑƒÐ²Ð°Ñ‚Ð¸ ÐºÐ½Ð¸Ð³Ñƒ",
            },

            delete_book: {
                en: "Delete book",
                uk: "Ð’Ð¸Ð´Ð°Ð»Ð¸Ñ‚Ð¸ ÐºÐ½Ð¸Ð³Ñƒ",
            },

            rename_book_question: {
                en: "Rename book?",
                uk: "ÐŸÐµÑ€ÐµÐ¹Ð¼ÐµÐ½ÑƒÐ²Ð°Ñ‚Ð¸ ÐºÐ½Ð¸Ð³Ñƒ?",
            },

            delete_book_question: {
                en: "Are you sure you want to remove the book from your library?",
                uk: "Ð’Ð¸ Ð´Ñ–Ð¹ÑÐ½Ð¾ Ñ…Ð¾Ñ‡ÐµÑ‚Ðµ Ð²Ð¸Ð´Ð°Ð»Ð¸Ñ‚Ð¸ ÐºÐ½Ð¸Ð³Ñƒ Ð· Ð±Ñ–Ð±Ð»Ñ–Ð¾Ñ‚ÐµÐºÐ¸?",
            },

            clear_library_question: {
                en: "Are you sure want to delete ALL books from the library?",
                uk: "Ð’Ð¸ Ð´Ñ–Ð¹ÑÐ½Ð¾ Ñ…Ð¾Ñ‡ÐµÑ‚Ðµ Ð²Ð¸Ð´Ð°Ð»Ð¸Ñ‚Ð¸ Ð£Ð¡Ð† ÐºÐ½Ð¸Ð³Ð¸ Ð· Ð±Ñ–Ð±Ð»Ñ–Ð¾Ñ‚ÐµÐºÐ¸?",
            },

            no_IndexedDB_message: {
                en: "Your browser doesn't support the stable version of IndexedDB. Some features will be unavailable.",
                uk: "Ð’Ð°Ñˆ Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€ Ð½Ðµ Ð¿Ñ–Ð´Ñ‚Ñ€Ð¸Ð¼ÑƒÑ” ÑÑ‚Ð°Ð±Ñ–Ð»ÑŒÐ½Ñƒ Ð²ÐµÑ€ÑÑ–ÑŽ IndexedDB. Ð”ÐµÑÐºÑ– Ñ„ÑƒÐ½ÐºÑ†Ñ–Ñ— Ð±ÑƒÐ´ÑƒÑ‚ÑŒ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ–.",
            },
        };


        // Refs
        const root_style = document.documentElement.style;
        const library_container = document.querySelector("[data-library-container]");
        const reader_container = document.querySelector("[data-reader-container]");
        const reader_book = document.querySelector("[data-reader-book]");
        const toolbar_title = document.querySelector("[data-toolbar-title]");
        const toolbar_progress_indicator = document.querySelector("[data-toolbar-progress-indicator]");
        const toolbar_battery_info = document.querySelector("[data-toolbar-battery-info]");
        const toolbox_container = document.querySelector("[data-toolbox-container]");
        const toolbox_library_tools = document.querySelector("[data-library-tools]");
        const toolbox_reader_tools = document.querySelector("[data-reader-tools]");
        const toolbox_main_tools = document.querySelector("[data-toolbox-main-tools]");
        const language_list = document.querySelector("[data-language-list]");
        const close_zone = document.querySelector("[data-close-zone]");
        const add_file_input = document.querySelector("[data-add-file-input]");
        const search_field = document.querySelector("[data-search-field]");
        const dialog_window = document.querySelector("[data-dialog-window]");
        const dialog_window_text = document.querySelector("[data-dialog-window-text]");
        const books_list = document.querySelector("[data-books-list]");

        // Buttons
        const reload_page = document.querySelector("[data-reload-page]");
        const toolbox_toggle_button = document.querySelector("[data-toolbox-toggle-button]");
        const cancel_button = document.querySelector("[data-cancel-button]");
        const confirm_button = document.querySelector("[data-confirm-button]");
        const clear_search_button = document.querySelector("[data-search-clear-button]");
        const back_button = document.querySelector("[data-back-button]");
        const back_to_library_button = document.querySelector("[data-back-to-library-button]");
        const full_screen_button = document.querySelector("[data-full-screen-button]");
        const full_screen_button2 = document.querySelector("[data-full-screen-button2]");
        const add_book_button = document.querySelector("[data-add-book-button]");
        const clear_library_button = document.querySelector("[data-clear-library-button]");
        const language_button = document.querySelector("[data-language-button]");


        // Switches
        let lang = localStorage.getItem("lang") || window.clientInformation.language;
        let is_lib_screen = true;
        let is_toolbox = false;
        let is_actions_tools = false;
        let active_row_actions = false;
        let active_book = false;
        let library_position = 0;
        let book_position = false;
        let interval_book_position = false;
        let is_battery_charging = false;
        let battery_level = 0;
        let set_reading_progress = () => { };


        // Automatic translation for the selected language
        function tr(label) { return translation[`${label}`][`${lang}`] || translation[`${label}`].en; };

        function translate_labels() {
            toolbox_toggle_button.title = tr("menu");
            toolbar_title.innerHTML = is_lib_screen ? tr("library") : "ÐšÐ½Ð¸Ð³Ð°";
            toolbar_progress_indicator.setAttribute("title", tr("read_title"));
            reload_page.setAttribute("title", tr("reload_page"));
            confirm_button.innerHTML = tr("confirm");
            cancel_button.innerHTML = tr("cancel");
            search_field.setAttribute("placeholder", tr("search_placeholder"));
            back_button.innerHTML = `ðŸ ” &nbsp; ${tr("back")}`;
            back_to_library_button.innerHTML = `ðŸ ” &nbsp; ${tr("library")}`;
            full_screen_button.innerHTML = tr("full_screen");
            full_screen_button2.innerHTML = tr("full_screen");
            add_book_button.innerHTML = tr("add_book");
            clear_library_button.innerHTML = tr("clear_library");
            language_button.innerHTML = `<span>${tr("language")}</span> <span>></span>`;
        }

        document.documentElement.setAttribute("lang", lang);
        translate_labels();


        // Creates languages list
        for (l in translation.language) {
            const lang_button = document.createElement("button");

            lang_button.setAttribute("class", "toolbox__button");
            lang_button.setAttribute("value", l);
            lang_button.setAttribute("onclick", `change_language("${l}")`);

            if (l === lang) {
                lang_button.textContent = "âœ“ " + translation.language[l];
                lang_button.setAttribute("style", "font-weight: bold");
            } else {
                lang_button.textContent = translation.language[l];
            };


            language_list.appendChild(lang_button);
        };


        // Create DB
        window.indexedDB =
            window.indexedDB ||
            window.mozIndexedDB ||
            window.webkitIndexedDB ||
            window.msIndexedDB;

        window.IDBTransaction =
            window.IDBTransaction ||
            window.webkitIDBTransaction ||
            window.msIDBTransaction;

        window.IDBKeyRange =
            window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;

        if (!window.indexedDB) window.alert(tr(no_IndexedDB_message));

        let db;
        const db_name = "ASHTIEMILE_READER";
        const request = indexedDB.open(db_name, 1);


        request.onupgradeneeded = function (event) { event.target.result.createObjectStore("books", { keyPath: "id" }); };
        request.onerror = function (event) { window.alert(event.target.error) };
        request.onsuccess = function (event) {
            db = event.target.result;
            render_library();
        };


        // Render books library
        function render_library() {
            disable_close_zone();
            close_toolbox();

            is_lib_screen = true;
            is_actions_tools = false;
            active_row_actions = false;
            active_book = false;
            book_position = false;

            toolbar_progress_indicator.style.display = "none";
            library_container.style.display = "block";
            reader_container.style.display = "none";
            root_style.setProperty("--scrollbar-progress", "0%");

            const tx = db.transaction("books", "readonly");
            const store = tx.objectStore("books");
            const requestAll = store.getAll();
            const search = search_field.value.toLowerCase();

            requestAll.onsuccess = () => {
                const books = requestAll.result;

                let recent = { recent: 0 };
                const favorites = [];
                const groups = {};

                if (!books[0]) {
                    books_list.setAttribute("class", "library__book_list__empty");
                    books_list.innerHTML = tr("library_empty");

                    const abb = document.createElement("div");
                    abb.setAttribute("onclick", "add_file_input.click()");
                    abb.setAttribute("style", "font-weight:bold;font-style:normal;cursor:pointer;");
                    abb.textContent = "âž• " + tr("add_book");
                    books_list.appendChild(abb);
                    return;
                };

                books_list.innerHTML = "";
                books_list.setAttribute("class", "library__book_list");

                books.forEach(b => {
                    if (b.recent > recent.recent && !b.read) recent = b;
                });

                books.filter(b => b.title.toLowerCase().includes(search) || b.author.toLowerCase().includes(search))
                    .forEach(b => {
                        if (b.favorite) favorites.push({ id: b.id, title: b.title, author: b.author, progress: b.progress, favorite: b.favorite, read: b.read });

                        if (!groups[b.author]) groups[b.author] = [];
                        groups[b.author].push({ id: b.id, title: b.title, author: b.author, progress: b.progress, favorite: b.favorite, read: b.read });
                    });

                // Recent book
                const rec = document.createElement("div");
                rec.setAttribute("class", "author__section");
                rec.setAttribute("style", "margin-bottom: 50px;");

                if (recent.title && !recent.read) {
                    rec.innerHTML = `
                        <div class="author__title">
                            <span>â†ª &nbsp; ${tr("recent")}</span>
                        </div>
                    `;

                    books_list.appendChild(rec);

                    const row_id = id_gen();

                    const rec_book = document.createElement("div");
                    rec_book.setAttribute("class", "book__row");
                    rec_book.setAttribute("id", row_id);
                    rec_book.setAttribute("onclick", `open_book('${recent.id}')`);

                    rec_book.innerHTML = `
                        <div class="book__title">
                            <span>${recent.title} &nbsp;&nbsp;</span> 
                            <span style="color: #aaa; font-style: italic;">[ ${recent.author} ]</span>
                        </div>

                        <div class="book__info">
                            <div class="book__progress" title="${tr("read_title")}">${if_book_reading(recent.progress)}</div>
                            <div class="book__actions_button" title="${tr("book_actions_title")}" onclick="event.stopPropagation(); show_actions_tools('${recent.id}', ${recent.favorite}, ${recent.read}, '${row_id}')"><b>&#8942;</b></div>
                        </div>
                    `;

                    rec.appendChild(rec_book);
                };

                // Favorites books
                const fav = document.createElement("div");
                fav.setAttribute("class", "author__section");
                fav.setAttribute("style", "margin-bottom: 50px;");

                if (favorites.length > 0) {
                    fav.innerHTML = `
                        <div class="author__title">
                            <span>â˜… &nbsp; ${tr("favorite")}</span>
                            <span class="author__counter">${favorites.length}</span>
                        </div>
                    `;

                    books_list.appendChild(fav);

                    favorites.sort((a, b) => a.title.localeCompare(b.title)).forEach(book => {
                        const row_id = id_gen();

                        const fav_book = document.createElement("div");
                        fav_book.setAttribute("class", "book__row");
                        fav_book.setAttribute("id", row_id);
                        fav_book.setAttribute("onclick", `open_book('${book.id}')`);

                        fav_book.innerHTML = `
                            <div class="book__title">
                                <span>${book.title} &nbsp;&nbsp;</span> 
                                <span style="color: #aaa; font-style: italic;">[ ${book.author} ]</span>
                            </div>

                            <div class="book__info">
                                <div class="book__progress" title="${tr("read_title")}">${if_book_reading(book.progress, book.read)}</div>
                                <div class="book__actions_button" title="${tr("book_actions_title")}" onclick="event.stopPropagation(); show_actions_tools('${book.id}', ${book.favorite}, ${book.read}, '${row_id}')"><b>&#8942;</b></div>
                            </div>
                        `;

                        fav.appendChild(fav_book);
                    });
                };

                // All books
                Object.keys(groups).sort().forEach(author => {
                    const sec = document.createElement("div");
                    sec.setAttribute("class", "author__section");
                    sec.innerHTML = `
                            <div class="author__title">
                                <span>${author}</span>
                                <span class="author__counter" title="${tr('author_books_counter')}">${groups[author].length}</span>
                            </div >
                        `;

                    groups[author].sort((a, b) => a.title.localeCompare(b.title)).forEach(book => {
                        function if_favorite() {
                            if (book.favorite) return "â˜…";
                            return "";
                        };

                        const row_id = id_gen();

                        const row = document.createElement("div");
                        row.setAttribute("class", "book__row");
                        row.setAttribute("id", row_id);
                        row.setAttribute("onclick", `open_book('${book.id}')`);

                        row.innerHTML = `
                            <div class="book__title">${book.title}</div>

                            <div class="book__info">
                                <div class="book__progress" title="${tr("read_title")}">${if_book_reading(book.progress, book.read)}</div>
                                <div class="book__favorite" title="${tr("favorite_title")}">${if_favorite()}</div>
                                <div class="book__actions_button" title="${tr("book_actions_title")}" onclick="event.stopPropagation(); show_actions_tools('${book.id}', ${book.favorite}, ${book.read}, '${row_id}')"><b>&#8942;</b></div>
                            </div>
                        `;

                        sec.appendChild(row);
                    });

                    books_list.appendChild(sec);
                });

                toolbar_title.innerHTML = `${tr("library")} &nbsp;&nbsp; [ ${books.length} ]`;
            };
        };


        // Events listeners
        window.addEventListener("resize", () => {
            if (!is_lib_screen) {
                scroll_to_paragraph();
            };
        });

        reload_page.addEventListener("click", () => { location.reload() });

        close_zone.addEventListener("click", () => {
            if (is_toolbox) close_toolbox();
            if (is_actions_tools) close_actions_tools();
        });

        cancel_button.addEventListener("click", () => {
            reset_dialog_window();
        });

        toolbox_toggle_button.addEventListener("click", () => {
            toolbox_container.style.display = is_toolbox ? "none" : "flex";
            is_toolbox = !is_toolbox;
            language_list.style.display = "none";
            toolbox_main_tools.style.display = "flex";

            if (!document.fullscreenElement) {
                full_screen_button.textContent = tr("full_screen");
                full_screen_button2.textContent = tr("full_screen");
            } else {
                full_screen_button.textContent = "âœ“ " + tr("full_screen");
                full_screen_button2.textContent = "âœ“ " + tr("full_screen");
            };

            if (is_toolbox) {
                enable_close_zone();
            } else {
                disable_close_zone();
            };
        });

        full_screen_button.addEventListener("click", () => {
            close_toolbox();

            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            };
        });

        full_screen_button2.addEventListener("click", () => {
            close_toolbox();

            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            };
        });

        search_field.addEventListener("input", () => render_library());

        add_book_button.addEventListener("click", () => {
            close_toolbox();
            add_file_input.click()
        });

        add_file_input.addEventListener("change", async (event) => {
            const files = Array.from(event.target.files);

            for (const file of files) {
                const text = await file.text();
                const doc = new DOMParser().parseFromString(text, "text/html");

                if (doc.querySelectorAll("p").length > 0) {
                    doc.querySelectorAll("p").forEach((p, index) => {
                        p.id = id_gen();
                    });
                } else {
                    doc.querySelectorAll("br").forEach((br, index) => {
                        br.id = id_gen();
                    });
                };

                const bookData = {
                    id: id_gen(4),
                    favorite: false,
                    read: false,
                    position: false,
                    progress: 0,
                    recent: 0,
                    author: doc.querySelector("h2")?.innerText.trim() || tr("unknown_author"),
                    title: doc.querySelector("h1")?.innerText.trim() || file.name.replace(".html", ""),
                    content: doc.body.innerHTML
                };

                const tx = db.transaction("books", "readwrite");
                tx.objectStore("books").put(bookData);
            }

            render_library();
        });

        clear_library_button.addEventListener("click", () => {
            close_toolbox();
            create_dialog_window(tr("clear_library_question"), "clear_library()");
        });

        language_button.addEventListener("click", () => {
            toolbox_main_tools.style.display = "none";
            language_list.style.display = "flex";
        });

        back_button.addEventListener("click", () => {
            language_list.style.display = "none";
            toolbox_main_tools.style.display = "flex";
        });

        back_to_library_button.addEventListener("click", () => {
            clearInterval(set_reading_progress);
            reader_container.style.display = "none";
            is_lib_screen = true;
            toggle_tools();
            render_library();
            window.scrollTo(0, parseFloat(library_position));
        });

        clear_search_button.addEventListener("click", () => {
            search_field.value = "";
            render_library();
        })



        // Enable close zone
        function enable_close_zone() {
            close_zone.style.display = "flex";
        };

        // Disable close zone
        function disable_close_zone() {
            close_zone.style.display = "none";
        };

        // Create dialog window
        function create_dialog_window(content, fn) {
            if (is_actions_tools) close_actions_tools();

            dialog_window_text.innerHTML = content;
            dialog_window.style.display = "flex";
            confirm_button.setAttribute("onclick", fn);
        };

        // Reset dialog window
        function reset_dialog_window() {
            dialog_window.style.display = "none";
            dialog_window_text.innerHTML = "";
            confirm_button.removeAttribute("onclick");
        };

        // Close toolbox
        function close_toolbox() {
            is_toolbox = false;
            toolbox_container.style.display = "none";
            disable_close_zone()
        };

        // Toggle tools
        function toggle_tools() {
            if (is_lib_screen) {
                toolbox_library_tools.style.display = "flex";
                toolbox_reader_tools.style.display = "none";
            } else {
                toolbox_library_tools.style.display = "none";
                toolbox_reader_tools.style.display = "flex";
            };
        };

        // Close actions tools
        function close_actions_tools() {
            document.getElementById(active_row_actions).remove();
            is_actions_tools = false;
            active_row_actions = false;
            disable_close_zone()
        };

        // Delete all books in library
        function clear_library() {
            db.transaction("books", "readwrite").objectStore("books").clear();
            reset_dialog_window();
            location.reload();
        };

        // Open selected book
        async function open_book(id) {
            const book = await new Promise((resolve) => {
                const tx = db.transaction("books", "readonly");
                const store = tx.objectStore("books");
                const req = store.get(id);
                req.onsuccess = () => resolve(req.result);
                req.onerror = function (event) { window.alert(event.target.error) };
            });

            if (book) {
                active_book = id;
                is_lib_screen = false;
                toggle_tools();
                change_recent(id);
                update_reading_progress();

                library_container.style.display = "none";
                reader_container.style.display = "flex";
                toolbar_title.innerHTML = `${book.title} â€” ${book.author}`;
                toolbar_progress_indicator.innerHTML = `${book.progress}%`;
                toolbar_progress_indicator.style.display = "block";
                reader_book.innerHTML = book.content;

                if (book.position) {
                    book_position = book.position;
                    scroll_to_paragraph();
                } else {
                    window.scrollTo(0, 0);
                };

                const winScroll = document.documentElement.scrollTop;
                const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
                const scrolled = height > 0 ? (winScroll / height) * 100 : 0;

                toolbar_progress_indicator.innerHTML = scrolled.toFixed(0) + "%";
                root_style.setProperty("--scrollbar-progress", scrolled.toFixed(0) + "%");
            };
        };

        // Change recent
        function change_recent(id) {
            const tx = db.transaction(["books"], "readwrite");
            const store = tx.objectStore("books");

            const req = store.get(id);

            req.onsuccess = function () {
                const book = req.result;

                if (book) {
                    book.recent = Date.now();

                    const updateRequest = store.put(book);

                    updateRequest.onerror = (event) => {
                        window.alert(event.target.error);
                    };
                };
            };

            req.onerror = function (event) { window.alert(event.target.error) };
        };

        // Update book position
        window.onscroll = () => {
            const winScroll = document.documentElement.scrollTop;
            const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            const scrolled = height > 0 ? (winScroll / height) * 100 : 0;

            toolbar_progress_indicator.innerHTML = scrolled.toFixed(0) + "%";
            root_style.setProperty("--scrollbar-progress", scrolled.toFixed(0) + "%");

            if (!is_lib_screen && active_book) {
                book_position = get_current_paragraph_id();
            } else {
                library_position = window.scrollY;
            };
        };

        function get_current_paragraph_id() {
            let closest_id = null;
            let min_dist = Infinity;

            if (document.querySelectorAll("p").length > 0) {
                const paragraphs = document.querySelectorAll("p");

                paragraphs.forEach(p => {
                    const rect = p.getBoundingClientRect();
                    const dist = Math.abs(rect.top);

                    if (rect.top < 100 && dist < min_dist) {
                        min_dist = dist;
                        closest_id = p.id;
                    }
                });
            } else {
                const row = document.querySelectorAll("br");

                row.forEach(br => {
                    const rect = br.getBoundingClientRect();
                    const dist = Math.abs(rect.top);

                    if (rect.top < 100 && dist < min_dist) {
                        min_dist = dist;
                        closest_id = br.id;
                    }
                });
            };

            return closest_id;
        }

        function update_reading_progress() {
            set_reading_progress = setInterval(() => {
                if (book_position === interval_book_position) return;

                interval_book_position = book_position;

                const winScroll = document.documentElement.scrollTop;
                const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
                const scrolled = height > 0 ? (winScroll / height) * 100 : 0;

                const tx = db.transaction(["books"], "readwrite");
                const store = tx.objectStore("books");

                const req = store.get(active_book);

                req.onsuccess = function () {
                    const book = req.result;

                    if (book) {
                        book.progress = scrolled.toFixed(0);
                        book.position = book_position;

                        if (scrolled.toFixed(0) >= 100) {
                            book.read = true;
                        };

                        const updateRequest = store.put(book);

                        updateRequest.onsuccess = () => { };

                        updateRequest.onerror = (event) => {
                            window.alert(event.target.error);
                        };
                    };
                };

                req.onerror = function (event) { window.alert(event.target.error) };
            }, 1000);
        };

        function scroll_to_paragraph() {
            const recent_paragraph = document.getElementById(book_position);
            const recent_paragraph_position = recent_paragraph.getBoundingClientRect().top + window.scrollY;
            const offset_position = recent_paragraph_position - 30;

            window.scrollTo({ top: offset_position });
        }

        // Indicator of reading progress
        function if_book_reading(progress_info = 0, read_info = false) {
            if (read_info) return "âœ”";
            if (progress_info > 0 && progress_info < 100) return progress_info + "%";
            return "";
        };

        // Show actions tools
        function show_actions_tools(book_id, book_favorite, book_read, row_id) {
            active_book = book_id;
            is_actions_tools = true;
            enable_close_zone();
            add_actions_tools(book_id, book_favorite, book_read, row_id);
        };

        // Add actions tools
        function add_actions_tools(book_id, book_favorite, book_read, row_id) {
            const row = document.getElementById(row_id);
            const actions_box_id = id_gen();

            active_row_actions = actions_box_id;

            const act = document.createElement("div");
            act.setAttribute("class", "actions_tools__container");
            act.setAttribute("id", active_row_actions);
            act.setAttribute("name", book_id);

            act.innerHTML = `
                <button class="toolbox__button" type="button" 
                    onclick="event.stopPropagation(); toggle_favorite()" >
                    ${book_favorite ? tr("remove_from_favorites") : tr("add_to_favorites")}
                </button>

                <button class="toolbox__button" type="button"
                    onclick="event.stopPropagation(); toggle_read()" >
                    ${book_read ? tr("mark_as_unread") : tr("mark_as_read")}
                </button>

                <button class="toolbox__button" type="button" 
                    onclick="event.stopPropagation(); rename_book_content()" >
                    ${tr("rename_book")}
                </button>

                <button class="toolbox__button" type="button" 
                    onclick="event.stopPropagation(); create_dialog_window('${tr("delete_book_question")}', 'delete_book()')" >
                    ${tr("delete_book")}
                </button>
            `;

            row.appendChild(act);
        };

        // Add to favorites or remove from favorites
        function toggle_favorite() {
            const tx = db.transaction(["books"], "readwrite");
            const store = tx.objectStore("books");

            const req = store.get(active_book);

            req.onsuccess = function () {
                const book = req.result;

                if (book) {
                    book.favorite = !book.favorite;

                    const updateRequest = store.put(book);

                    updateRequest.onsuccess = () => {
                        render_library();
                    };

                    updateRequest.onerror = (event) => {
                        window.alert(event.target.error);
                    };
                };
            };

            req.onerror = function (event) { window.alert(event.target.error) };
        };

        // Toggle read
        function toggle_read() {
            const tx = db.transaction(["books"], "readwrite");
            const store = tx.objectStore("books");

            const req = store.get(active_book);

            req.onsuccess = function () {
                const book = req.result;

                if (book) {
                    book.read = !book.read;

                    const updateRequest = store.put(book);

                    updateRequest.onsuccess = () => {
                        render_library();
                    };

                    updateRequest.onerror = (event) => {
                        window.alert(event.target.error);
                    };
                };
            };

            req.onerror = function (event) { window.alert(event.target.error) };
        };

        // Rename book name or author
        async function rename_book_content() {
            const book = await new Promise((resolve) => {
                const tx = db.transaction("books", "readonly");
                const store = tx.objectStore("books");
                const req = store.get(active_book);
                req.onsuccess = () => resolve(req.result);
            });

            if (book) {
                const content = `
                    <div class="rename_book__form">
                        <span><b>${tr("book_author")}:</b></span>
                        <input class="rename_book__input" type="text" id="edit_author" value="${book.author}">

                        <span><b>${tr("book_title")}:</b></span>
                        <input class="rename_book__input" type="text" id="edit_title" value="${book.title}">

                        <span class="rename_book__question">${tr("rename_book_question")}</span>
                    </div>
                `;

                create_dialog_window(content, "rename_book()");
            }
        };

        function rename_book() {
            const newAuthor = document.getElementById("edit_author").value;
            const newTitle = document.getElementById("edit_title").value;

            const tx = db.transaction("books", "readwrite");
            const store = tx.objectStore("books");

            const req = store.get(active_book);

            req.onsuccess = () => {
                const data = req.result;
                data.author = newAuthor;
                data.title = newTitle;
                store.put(data);

                reset_dialog_window();
                render_library();
            };

            req.onerror = function (event) { window.alert(event.target.error) };
        };

        // Delete book from library
        function delete_book() {
            db.transaction("books", "readwrite").objectStore("books").delete(active_book);
            reset_dialog_window();
            render_library();
        };

        // Changes the language of the program
        function change_language(lng) {
            document.documentElement.setAttribute("lang", lng);
            localStorage.setItem("lang", lng);
            location.reload();
        };

        // ID generator
        function id_gen(n = 1) {
            let id = "";
            for (let i = 1; i <= n; i++) { id = id + Math.random().toString(36).substring(2, 10); };
            return id;
        };

        // Intervals
        setInterval(() => {
            navigator.getBattery().then((battery) => {
                battery_level = battery.level;
                is_battery_charging = battery.charging;

                toolbar_battery_info.innerHTML = `â©€ ${battery.level * 100}%`;
            });
        }, 1000);
    </script>
</body>

</html>